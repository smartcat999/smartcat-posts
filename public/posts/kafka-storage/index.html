<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Smartcat&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="[TOC]
1 kafka 数据存储格式 字段含义
字段名 字段含义 baseOffset 消息的起始offset batchLength 消息数量 magic 用于扩展信息，当前版本为2 crc crc校验 attributes int16, 0~2位表示压缩算法 3位表示时间戳类型，4位表示是否使用事务，5位表示是否是控制消息， 6～15暂时没用 lastOffsetDelta BatchRecords中最后一条消息相对与baseOffset的值 firstTimestamp BatchRecords中最早一条消息的时间戳 maxTimestamp BatchRecords中最新一条消息的时间戳 producerId 生产者ID producerEpoch 支持生产者消息幂等 baseSequence 起始消息序列号 records 消息内容 2 存储空间大小计算 消息大小 * 当天消息数 * 消息保留天数 * 消息副本数 * （ 1 &#43; 索引文件百分比 ） * 压缩比 * （1 &#43; 预留空间百分比） / 1024 / 1024 / 1024 TB 例如：1KB * 1亿 * 7天 * 3个副本 * (1 &#43; 10%) * 0.">
    <meta name="generator" content="Hugo 0.104.3" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="" />
<meta property="og:description" content="[TOC]
1 kafka 数据存储格式 字段含义
字段名 字段含义 baseOffset 消息的起始offset batchLength 消息数量 magic 用于扩展信息，当前版本为2 crc crc校验 attributes int16, 0~2位表示压缩算法 3位表示时间戳类型，4位表示是否使用事务，5位表示是否是控制消息， 6～15暂时没用 lastOffsetDelta BatchRecords中最后一条消息相对与baseOffset的值 firstTimestamp BatchRecords中最早一条消息的时间戳 maxTimestamp BatchRecords中最新一条消息的时间戳 producerId 生产者ID producerEpoch 支持生产者消息幂等 baseSequence 起始消息序列号 records 消息内容 2 存储空间大小计算 消息大小 * 当天消息数 * 消息保留天数 * 消息副本数 * （ 1 &#43; 索引文件百分比 ） * 压缩比 * （1 &#43; 预留空间百分比） / 1024 / 1024 / 1024 TB 例如：1KB * 1亿 * 7天 * 3个副本 * (1 &#43; 10%) * 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/kafka-storage/" /><meta property="article:section" content="posts" />



<meta itemprop="name" content="">
<meta itemprop="description" content="[TOC]
1 kafka 数据存储格式 字段含义
字段名 字段含义 baseOffset 消息的起始offset batchLength 消息数量 magic 用于扩展信息，当前版本为2 crc crc校验 attributes int16, 0~2位表示压缩算法 3位表示时间戳类型，4位表示是否使用事务，5位表示是否是控制消息， 6～15暂时没用 lastOffsetDelta BatchRecords中最后一条消息相对与baseOffset的值 firstTimestamp BatchRecords中最早一条消息的时间戳 maxTimestamp BatchRecords中最新一条消息的时间戳 producerId 生产者ID producerEpoch 支持生产者消息幂等 baseSequence 起始消息序列号 records 消息内容 2 存储空间大小计算 消息大小 * 当天消息数 * 消息保留天数 * 消息副本数 * （ 1 &#43; 索引文件百分比 ） * 压缩比 * （1 &#43; 预留空间百分比） / 1024 / 1024 / 1024 TB 例如：1KB * 1亿 * 7天 * 3个副本 * (1 &#43; 10%) * 0.">

<meta itemprop="wordCount" content="1395">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="[TOC]
1 kafka 数据存储格式 字段含义
字段名 字段含义 baseOffset 消息的起始offset batchLength 消息数量 magic 用于扩展信息，当前版本为2 crc crc校验 attributes int16, 0~2位表示压缩算法 3位表示时间戳类型，4位表示是否使用事务，5位表示是否是控制消息， 6～15暂时没用 lastOffsetDelta BatchRecords中最后一条消息相对与baseOffset的值 firstTimestamp BatchRecords中最早一条消息的时间戳 maxTimestamp BatchRecords中最新一条消息的时间戳 producerId 生产者ID producerEpoch 支持生产者消息幂等 baseSequence 起始消息序列号 records 消息内容 2 存储空间大小计算 消息大小 * 当天消息数 * 消息保留天数 * 消息副本数 * （ 1 &#43; 索引文件百分比 ） * 压缩比 * （1 &#43; 预留空间百分比） / 1024 / 1024 / 1024 TB 例如：1KB * 1亿 * 7天 * 3个副本 * (1 &#43; 10%) * 0."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Smartcat&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1"></h1>
      
      
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>[TOC]</p>
<h5 id="1-kafka-数据存储格式">1 kafka 数据存储格式</h5>
<p><img src="/api/static/msg.png" alt="图片">
<strong>字段含义</strong></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>baseOffset</td>
<td>消息的起始offset</td>
</tr>
<tr>
<td>batchLength</td>
<td>消息数量</td>
</tr>
<tr>
<td>magic</td>
<td>用于扩展信息，当前版本为2</td>
</tr>
<tr>
<td>crc</td>
<td>crc校验</td>
</tr>
<tr>
<td>attributes</td>
<td>int16, 0~2位表示压缩算法 3位表示时间戳类型，4位表示是否使用事务，5位表示是否是控制消息， 6～15暂时没用</td>
</tr>
<tr>
<td>lastOffsetDelta</td>
<td>BatchRecords中最后一条消息相对与baseOffset的值</td>
</tr>
<tr>
<td>firstTimestamp</td>
<td>BatchRecords中最早一条消息的时间戳</td>
</tr>
<tr>
<td>maxTimestamp</td>
<td>BatchRecords中最新一条消息的时间戳</td>
</tr>
<tr>
<td>producerId</td>
<td>生产者ID</td>
</tr>
<tr>
<td>producerEpoch</td>
<td>支持生产者消息幂等</td>
</tr>
<tr>
<td>baseSequence</td>
<td>起始消息序列号</td>
</tr>
<tr>
<td>records</td>
<td>消息内容</td>
</tr>
</tbody>
</table>
<h5 id="2-存储空间大小计算">2 存储空间大小计算</h5>
<p><strong>消息大小 * 当天消息数 * 消息保留天数 * 消息副本数 * （ 1 + 索引文件百分比 ） * 压缩比 * （1 + 预留空间百分比） / 1024 /
1024 / 1024 TB
例如：1KB * 1亿 * 7天 * 3个副本 * (1 + 10%) * 0.8 / 1024 / 1024 / 1024 约等于 1.8TB， 一天1亿的消息量，每条消息大小1KB，topic3个副本，
索引文件比例按 10% ～
20%， 压缩比率按 10 % ～ 20%，压缩之后文件大小为源文件大小80% ～ 90%， 计算范围在 1.8TB ～ 2.2TB， 预留10% ～ 20%空间，安全阈值
2.0TB ～ 2.7TB。 <br>
按1千个设备，每个设备20个测点，一共2w个测点，一秒钟上报一次数据计算， 单条消息大小 1KB， 每秒的推送消息大小 1KB，
kafka内部分发一次，每秒产生的消息大小 1KB * 2 = 2KB， 单个设备每天的推送消息大小 2 *
60 * 60 * 24 = 172800KB，约等于168.75MB， 所有设备每天累计推送消息大小 172800KB * 1000个 = 172800000KB，约等于164.80GB,
按公式计算 3045.41GB ～
3737.55GB,换算为 2.97TB ～ 3.65TB，加上预留空间10%，安全阈值 3.27TB ～ 4.02TB。</strong></p>
<h5 id="3-kafka消息写入存储空间测试">3 kafka消息写入存储空间测试</h5>
<h6 id="31-安装kafkahelm">3.1 安装kafka(helm)</h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 安装kafka</span>
</span></span><span style="display:flex;"><span>$ helm repo add bitnami https://charts.bitnami.com/bitnami
</span></span><span style="display:flex;"><span>$ helm install kafka-master bitnami/kafka -n ps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装kafka-client</span>
</span></span><span style="display:flex;"><span>$ kubectl run kafka-master-client --restart<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Never&#39;</span> --image docker.io/bitnami/kafka:3.2.0-debian-10-r4 --namespace ps --command -- sleep infinity
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 进入容器</span>
</span></span><span style="display:flex;"><span>$ kubectl exec --tty -i kafka-master-client --namespace ps -- bash
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用client调用kafka-server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置环境变量kafka-server地址</span>
</span></span><span style="display:flex;"><span>$ export kafka<span style="color:#f92672">=</span>kafka-master-0.kafka-master-headless.ps.svc.cluster.local:9092
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cd /opt/bitnami/kafka/bin
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建topic</span>
</span></span><span style="display:flex;"><span>$ kafka-topics.sh --create --topic test --bootstrap-server $kafka
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动 consumer-console</span>
</span></span><span style="display:flex;"><span>$ kafka-console-consumer.sh --topic test --from-beginning --bootstrap-server $kafka
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动 producer-console</span>
</span></span><span style="display:flex;"><span>$ kafka-console-producer.sh --topic test --bootstrap-server $kafka
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看日志文件</span>
</span></span><span style="display:flex;"><span>$ /opt/bitnami/kafka/bin/kafka-run-class.sh kafka.tools.DumpLogSegments --files 00000000000000000000.log --print-data-log
</span></span><span style="display:flex;"><span>$ /opt/bitnami/kafka/bin/kafka-dump-log.sh --files 00000000000000000000.log --print-data-log
</span></span><span style="display:flex;"><span><span style="color:#75715e"># output:</span>
</span></span><span style="display:flex;"><span>baseOffset: <span style="color:#ae81ff">45</span> lastOffset: <span style="color:#ae81ff">45</span> count: <span style="color:#ae81ff">1</span> baseSequence: <span style="color:#ae81ff">0</span> lastSequence: <span style="color:#ae81ff">0</span> producerId: -1 producerEpoch: -1 partitionLeaderEpoch: <span style="color:#ae81ff">0</span> isTransactional: false isControl: false deleteHorizonMs: OptionalLong.empty position: <span style="color:#ae81ff">2031009</span> CreateTime: <span style="color:#ae81ff">1654672883918</span> size: <span style="color:#ae81ff">331</span> magic: <span style="color:#ae81ff">2</span> compresscodec: gzip crc: <span style="color:#ae81ff">4084402132</span> isvalid: true
</span></span><span style="display:flex;"><span>| offset: <span style="color:#ae81ff">45</span> CreateTime: <span style="color:#ae81ff">1654672883918</span> keySize: -1 valueSize: <span style="color:#ae81ff">389</span> sequence: <span style="color:#ae81ff">0</span> headerKeys: <span style="color:#f92672">[]</span> payload: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;widget&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;debug&#34;</span>:<span style="color:#e6db74">&#34;on&#34;</span>,<span style="color:#e6db74">&#34;window&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Sample Konfabulator Widget&#34;</span>,<span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;main_window&#34;</span>,<span style="color:#e6db74">&#34;width&#34;</span>:500,<span style="color:#e6db74">&#34;height&#34;</span>:500<span style="color:#f92672">}</span>,<span style="color:#e6db74">&#34;image&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;src&#34;</span>:<span style="color:#e6db74">&#34;Images/Sun.png&#34;</span>,<span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;sun1&#34;</span>,<span style="color:#e6db74">&#34;hOffset&#34;</span>:250,<span style="color:#e6db74">&#34;vOffset&#34;</span>:250,<span style="color:#e6db74">&#34;alignment&#34;</span>:<span style="color:#e6db74">&#34;center&#34;</span><span style="color:#f92672">}</span>,<span style="color:#e6db74">&#34;text&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;data&#34;</span>:<span style="color:#e6db74">&#34;Click Here&#34;</span>,<span style="color:#e6db74">&#34;size&#34;</span>:36,<span style="color:#e6db74">&#34;style&#34;</span>:<span style="color:#e6db74">&#34;bold&#34;</span>,<span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;text1&#34;</span>,<span style="color:#e6db74">&#34;hOffset&#34;</span>:250,<span style="color:#e6db74">&#34;vOffset&#34;</span>:100,<span style="color:#e6db74">&#34;alignment&#34;</span>:<span style="color:#e6db74">&#34;center&#34;</span>,<span style="color:#e6db74">&#34;onMouseUp&#34;</span>:<span style="color:#e6db74">&#34;sun1.opacity = (sun1.opacity / 100) * 90;&#34;</span><span style="color:#f92672">}}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看索引文件</span>
</span></span><span style="display:flex;"><span>$ /opt/bitnami/kafka/bin/kafka-dump-log.sh --files 00000000000000000000.index
</span></span><span style="display:flex;"><span>$ /opt/bitnami/kafka/bin/kafka-dump-log.sh --files 00000000000000000000.timeindex
</span></span></code></pre></div><h6 id="32-写入测试">3.2 写入测试</h6>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// consumer.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">kafka_demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/Shopify/sarama&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os/signal&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">KafkaClient</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">topics</span>        []<span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">consumerGroup</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerGroup</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewKafkaClient</span>(<span style="color:#a6e22e">brokers</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">topics</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">groupID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">oldest</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">version</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">assignor</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">verbose</span> <span style="color:#66d9ef">bool</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">KafkaClient</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">verbose</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">Logger</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>, <span style="color:#e6db74">&#34;[sarama] &#34;</span>, <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">LstdFlags</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">NewConfig</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ver</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ParseKafkaVersion</span>(<span style="color:#a6e22e">version</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Version</span> = <span style="color:#a6e22e">ver</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">assignor</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;sticky&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Consumer</span>.<span style="color:#a6e22e">Group</span>.<span style="color:#a6e22e">Rebalance</span>.<span style="color:#a6e22e">Strategy</span> = <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">BalanceStrategySticky</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;roundrobin&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Consumer</span>.<span style="color:#a6e22e">Group</span>.<span style="color:#a6e22e">Rebalance</span>.<span style="color:#a6e22e">Strategy</span> = <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">BalanceStrategyRoundRobin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;range&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Consumer</span>.<span style="color:#a6e22e">Group</span>.<span style="color:#a6e22e">Rebalance</span>.<span style="color:#a6e22e">Strategy</span> = <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">BalanceStrategyRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;Unrecognized consumer group partition assignor: %s&#34;</span>, <span style="color:#a6e22e">assignor</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">oldest</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">Consumer</span>.<span style="color:#a6e22e">Offsets</span>.<span style="color:#a6e22e">Initial</span> = <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">OffsetOldest</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">kafkaClient</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">KafkaClient</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">topics</span>: <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">topics</span>, <span style="color:#e6db74">&#34;,&#34;</span>),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">kafkaClient</span>.<span style="color:#a6e22e">consumerGroup</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">NewConsumerGroup</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">brokers</span>, <span style="color:#e6db74">&#34;,&#34;</span>), <span style="color:#a6e22e">groupID</span>, <span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">kafkaClient</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">k</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">KafkaClient</span>) <span style="color:#a6e22e">Consume</span>(<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">Handler</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">keepRunning</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Starting a new Sarama consumer&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Setup a new Sarama consumer group
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">consumer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Consumer</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ready</span>:   make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">handler</span>: <span style="color:#a6e22e">handler</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">consumptionIsPaused</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// `Consume` should be called inside an infinite loop, when a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// server-side rebalance happens, the consumer session will need to be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// recreated to get the new claims
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">consumerGroup</span>.<span style="color:#a6e22e">Consume</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">topics</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">consumer</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;Error from consumer: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// check if context was cancelled, signaling that the consumer should stop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Err</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">consumer</span>.<span style="color:#a6e22e">ready</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">consumer</span>.<span style="color:#a6e22e">ready</span> <span style="color:#75715e">// Await till the consumer has been set up
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Sarama consumer up and running!...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sigusr1</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">sigusr1</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGUSR1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sigterm</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Signal</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">Notify</span>(<span style="color:#a6e22e">sigterm</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGINT</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">keepRunning</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;terminating: context cancelled&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">keepRunning</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sigterm</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;terminating: via signal&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">keepRunning</span> = <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sigusr1</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">toggleConsumptionFlow</span>(<span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">consumerGroup</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">consumptionIsPaused</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">consumerGroup</span>.<span style="color:#a6e22e">Close</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;Error closing client: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">toggleConsumptionFlow</span>(<span style="color:#a6e22e">client</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerGroup</span>, <span style="color:#a6e22e">isPaused</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">isPaused</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">ResumeAll</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Resuming consumption&#34;</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">PauseAll</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Pausing consumption&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">isPaused</span> = !<span style="color:#f92672">*</span><span style="color:#a6e22e">isPaused</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Consumer represents a Sarama consumer group consumer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Consumer</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ready</span>   <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">Handler</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Setup is run at the beginning of a new session, before ConsumeClaim
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">consumer</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Consumer</span>) <span style="color:#a6e22e">Setup</span>(<span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerGroupSession</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Mark the consumer as ready
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	close(<span style="color:#a6e22e">consumer</span>.<span style="color:#a6e22e">ready</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Cleanup is run at the end of a session, once all ConsumeClaim goroutines have exited
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">consumer</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Consumer</span>) <span style="color:#a6e22e">Cleanup</span>(<span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerGroupSession</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ConsumeClaim must start a consumer loop of ConsumerGroupClaim&#39;s Messages().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">consumer</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Consumer</span>) <span style="color:#a6e22e">ConsumeClaim</span>(<span style="color:#a6e22e">session</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerGroupSession</span>, <span style="color:#a6e22e">claim</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerGroupClaim</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// NOTE:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Do not move the code below to a goroutine.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// The `ConsumeClaim` itself is called within a goroutine, see:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://github.com/Shopify/sarama/blob/main/consumer_group.go#L27-L29
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">message</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">claim</span>.<span style="color:#a6e22e">Messages</span>():
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Message claimed: value = %s, timestamp = %v, topic = %s&#34;</span>, string(<span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Value</span>), <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Timestamp</span>, <span style="color:#a6e22e">message</span>.<span style="color:#a6e22e">Topic</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">consumer</span>.<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">message</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">MarkMessage</span>(<span style="color:#a6e22e">message</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Should return when `session.Context()` is done.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// If not, will raise `ErrRebalanceInProgress` or `read tcp &lt;ip&gt;:&lt;port&gt;: i/o timeout` when kafka rebalance. see:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// https://github.com/Shopify/sarama/issues/1192
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">session</span>.<span style="color:#a6e22e">Context</span>().<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Handler</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">message</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ConsumerMessage</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// producer.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">kafka_demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/Shopify/sarama&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">kafkaSyncProducer</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Topic</span>        <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">syncProducer</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">SyncProducer</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewKafkaSyncProducer</span>(<span style="color:#a6e22e">brokers</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">topic</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">kafkaSyncProducer</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">NewSyncProducer</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">brokers</span>, <span style="color:#e6db74">&#34;,&#34;</span>), <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">kafkaSyncProducer</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Topic</span>:        <span style="color:#a6e22e">topic</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">syncProducer</span>: <span style="color:#a6e22e">pr</span>,
</span></span><span style="display:flex;"><span>	}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">k</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kafkaSyncProducer</span>) <span style="color:#a6e22e">SendMessages</span>(<span style="color:#a6e22e">messages</span> [][]<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">producerMessages</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ProducerMessage</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">messages</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">producerMessages</span> = append(<span style="color:#a6e22e">producerMessages</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ProducerMessage</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Topic</span>:     <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">Topic</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Key</span>:       <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Value</span>:     <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ByteEncoder</span>(<span style="color:#a6e22e">msg</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Headers</span>:   <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Metadata</span>:  <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Offset</span>:    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Partition</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Timestamp</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>{},
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">producerMessages</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">syncProducer</span>.<span style="color:#a6e22e">SendMessages</span>(<span style="color:#a6e22e">producerMessages</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">k</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kafkaSyncProducer</span>) <span style="color:#a6e22e">SendMessage</span>(<span style="color:#a6e22e">message</span> []<span style="color:#66d9ef">byte</span>) (<span style="color:#a6e22e">partition</span> <span style="color:#66d9ef">int32</span>, <span style="color:#a6e22e">offset</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">partition</span>, <span style="color:#a6e22e">offset</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">syncProducer</span>.<span style="color:#a6e22e">SendMessage</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ProducerMessage</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Topic</span>:     <span style="color:#a6e22e">k</span>.<span style="color:#a6e22e">Topic</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Key</span>:       <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Value</span>:     <span style="color:#a6e22e">sarama</span>.<span style="color:#a6e22e">ByteEncoder</span>(<span style="color:#a6e22e">message</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Headers</span>:   <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Metadata</span>:  <span style="color:#66d9ef">nil</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Offset</span>:    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Partition</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Timestamp</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>{},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// size.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">kafka_demo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;math/rand&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;unsafe&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newMessage</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//fmt.Println(unsafe.Sizeof([128]int64{}))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">msg1Kb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">new1KbMessage</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;1KB: size = %d byte\n&#34;</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">msg1Kb</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg1Mb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">new100KbMessage</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;100KB: size = %d byte\n&#34;</span>, <span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Sizeof</span>(<span style="color:#a6e22e">msg1Mb</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">new1KbMessage</span>() [<span style="color:#ae81ff">1024</span>]<span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">1024</span>]<span style="color:#66d9ef">byte</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">new100KbMessage</span>() [<span style="color:#ae81ff">102400</span>]<span style="color:#66d9ef">byte</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">102400</span>]<span style="color:#66d9ef">byte</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">102400</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Seed</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">v</span>[<span style="color:#a6e22e">i</span>] = byte(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#ae81ff">100</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">v</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code># producer_test.go
package kafka_demo

import (
	&#34;strconv&#34;
	&#34;testing&#34;
)

func newDefaultProducer() *kafkaSyncProducer {
	brokers := &#34;kafka-master-0.kafka-master-headless.ps.svc.cluster.local:9092&#34;
	topics := &#34;test&#34;
	ps, _ := NewKafkaSyncProducer(brokers, topics)
	return ps
}

func TestSyncProducer(t *testing.T) {
	brokers := &#34;kafka-master-0.kafka-master-headless.ps.svc.cluster.local:9092&#34;
	topics := &#34;test&#34;
	ps, _ := NewKafkaSyncProducer(brokers, topics)
	for i := 0; i &lt; 16; i++ {
		val := []byte(strconv.FormatInt(int64(i), 10))
		_, _, err := ps.SendMessage(val)
		if err != nil {
			t.Error(err)
		} else {
			//t.Logf(&#34;produce Message: value = %s, partition = %v, offset = %v&#34;, string(val), partition, offset)
		}
	}
}

func TestSyncProducer1Kb(t *testing.T) {
	producer := newDefaultProducer()
	m := new1KbMessage()
	counter := 1024 * 50
	for i := 0; i &lt; counter; i++ {
		_, _, err := producer.SendMessage(m[:])
		if err != nil {
			t.Error(err)
		}
	}
	producer.syncProducer.Close()
}

func TestSyncProducer500KB(t *testing.T) {
	producer := newDefaultProducer()
	m := new100KbMessage()
	counter := 512
	for i := 0; i &lt; counter; i++ {
		_, _, err := producer.SendMessage(m[:])
		if err != nil {
			t.Error(err)
		}
	}
	producer.syncProducer.Close()
}

func TestSyncProducerString(t *testing.T) {
	producer := newDefaultProducer()
	m := []byte(`{&#34;name&#34;: &#34;Bob&#34;, &#34;age&#34;: 20}`)
	counter := 512
	for i := 0; i &lt; counter; i++ {
		_, _, err := producer.SendMessage(m[:])
		if err != nil {
			t.Error(err)
		}
	}
	producer.syncProducer.Close()
}
</code></pre><h6 id="33-100kb消息写入">3.3 100KB消息写入</h6>
<ol>
<li>GZIP</li>
</ol>
<pre tabindex="0"><code># 50MB消息，单条消息100KB
# 写入前
0       00000000000000000000.index
0       00000000000000000000.log
0       00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata

#写入后
8.0K    00000000000000000000.index
43M     00000000000000000000.log
8.0K    00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata

# 50MB消息，单条消息100KB
# 写入前
8.0K    00000000000000000000.index
43M     00000000000000000000.log
8.0K    00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata

# 写入后
12K     00000000000000000000.index
85M     00000000000000000000.log
16K     00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata
</code></pre><ol start="2">
<li>Snappy</li>
</ol>
<pre tabindex="0"><code># 50MB消息，单条消息100KB
# 写入前
28K     00000000000000000000.index
277M    00000000000000000000.log
40K     00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata

# 写入后
32K     00000000000000000000.index
327M    00000000000000000000.log
44K     00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata
</code></pre><ol start="3">
<li>LZ4</li>
</ol>
<pre tabindex="0"><code># 50MB消息，单条消息100KB
# 写入前
32K     00000000000000000000.index
327M    00000000000000000000.log
44K     00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata

# 写入后
36K     00000000000000000000.index
377M    00000000000000000000.log
52K     00000000000000000000.timeindex
4.0K    leader-epoch-checkpoint
4.0K    partition.metadata
</code></pre><ol start="4">
<li>ZSTD</li>
</ol>
<ul>
<li>测试方式</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span># 50MB消息，单条消息100KB
</span></span><span style="display:flex;"><span># 写入前
</span></span><span style="display:flex;"><span>24K     00000000000000000000.index
</span></span><span style="display:flex;"><span>235M    00000000000000000000.log
</span></span><span style="display:flex;"><span>32K     00000000000000000000.timeindex
</span></span><span style="display:flex;"><span>4.0K    leader-epoch-checkpoint
</span></span><span style="display:flex;"><span>4.0K    partition.metadata
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># 写入后
</span></span><span style="display:flex;"><span>28K     00000000000000000000.index
</span></span><span style="display:flex;"><span>277M    00000000000000000000.log
</span></span><span style="display:flex;"><span>40K     00000000000000000000.timeindex
</span></span><span style="display:flex;"><span>4.0K    leader-epoch-checkpoint
</span></span><span style="display:flex;"><span>4.0K    partition.metadata
</span></span></code></pre></div><ul>
<li>结果
<table>
<thead>
<tr>
<th style="text-align:center">压缩算法</th>
<th style="text-align:center">GZIP</th>
<th style="text-align:center">Snappy</th>
<th style="text-align:center">ZSTD</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">压缩率</td>
<td style="text-align:center">0.86</td>
<td style="text-align:center">-</td>
<td style="text-align:center">0.84</td>
</tr>
</tbody>
</table>
</li>
</ul>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy;  Smartcat's Blog 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
